---
title: "Food Deserts Analysis"
output: html_document
---
## Data Loading and Preprocessing
```{r init, include=F}
library(tidyverse)
library(ezids)
library(usmap)
```

```{r read_data}
# Loading data
data <- read.csv("food_access_research_atlas.csv")

```

## Questions 1a: Geographic Distribution of State/County wise Prevelance of Food Deserts

```{r}
plot_map <- function(dataset, colx, region, subx) {
  grpddata <- dataset %>%
    filter(.data[[colx]] == 1) %>% # Filtering the food desert flags
    group_by(State, County) %>% # Grouping by State and County
    reframe(full = State, count = sum(.data[[colx]]))  # Reframing to dataframe for Plotting
  grpddata$county <-
    paste(grpddata$County, "County") # Adding " County" text to support prerequisite of the plot_usmap() counties
  grpddata <-
    distinct(grpddata, .keep_all = TRUE) %>% select(full, county, count) # Ignoring the duplicates and selecting particular columns to supply the plot_usmap()
  counties_df <-
    us_map("counties") %>% select(fips, full, county) %>% distinct() # Getting the FIPS data of the counties. Mandatory for plotting in maps. Available from the us_map() dataframe built-in with the plot_usmap() library
  merged_df <-
    grpddata %>% right_join(counties_df, by = c("county", "full")) # Right joining the dataframes to get relevant FIPS code
  
  if (region == "State") {
    merged_df <-
      merged_df %>% select(-fips) %>% rename(state = full) # Changing the structure for State wise plotting
  }
  state_map <-
    plot_usmap("states", color = "#ff000030", size = 0.01)
  
  counties_map <- plot_usmap(
    data = merged_df,
    values = "count",
    color = "black",
    size = 0.1
  )
  
  # Merging both the plots using ggplot and rendering the combined map using geom_polygon()
  ggplot() +
    geom_polygon(
      data = counties_map[[1]],
      aes(
        x = x,
        y = y,
        group = group,
        fill = counties_map[[1]]$count,
      ),
      color = "black",
      size = 0.1
    ) +
    geom_polygon(
      data = state_map[[1]],
      aes(x = x,
          y = y,
          group = group),
      color = "#ff000030",
      fill = alpha(0.01)
    ) +
    coord_equal() +
    theme(
      panel.grid = element_blank(),
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      strip.text = element_blank(),
      plot.subtitle = element_text(size = rel(0.8)),
      panel.background = element_rect(fill = "white"),
      
    ) +
    scale_fill_gradient(low = 'white', high = 'grey20') +
    labs(
      title = paste(region, "- Wise Geographic Distribution of Food Desert in US"),
      subtitle = subx,
      fill = "Prevelance of FD"
    )
}


plot_map(data, colx = "LILATracts_halfAnd10", region="County", subx="LI and LA half and 10 miles for Urban and Rural")
plot_map(data, colx = "LILATracts_1And10", region="County", subx="LI and LA 1 and 10 miles for Urban and Rural")
plot_map(data, colx = "LILATracts_1And20", region="County", subx="LI and LA 1 and 20 miles for Urban and Rural")
plot_map(data, colx = "LILATracts_halfAnd10", region="State", subx="LI and LA half and 10 miles for Urban and Rural")
plot_map(data, colx = "LILATracts_1And10", region="State", subx="LI and LA 1 and 10 miles for Urban and Rural")
plot_map(data, colx = "LILATracts_1And20", region="State", subx="LI and LA 1 and 20 miles for Urban and Rural")
```

## Question 1b: Unique states and counties are represented in the dataset

```{r}
unique_states <- data %>% group_by(State) %>% distinct(State) # Grouping by State and using distinct() to get unique states
unique_counties <- data %>% group_by(State, County) %>% distinct(County) 
# Grouping by both State and County and then 
# using distinct() to get unique states. Because directly Grouping the counties will result in lesser results as different 
# counties in different States can exists with the same name
```
## Question 1c: Total census tracts included in the dataset
```{r}
total_census_tracts <- nrow(data)
```

```{r}
unique_states <- data %>% group_by(State) %>% distinct(State) # Grouping by State and using distinct() to get unique states
unique_counties <- data %>% group_by(State, County) %>% distinct(County) 
# Grouping by both State and County and then 
# using distinct() to get unique states. Because directly Grouping the counties will result in lesser results as different 
# counties in different States can exists with the same name
```

## Question 2: Urban vs Rural Classification impacts
```{r}
total_count <- nrow(data)
urban_count <- nrow(data %>% filter(Urban == 1))
rural_count <- nrow(data %>% filter(Urban == 0))
urban_food_desert_count <- nrow(data %>% filter(Urban == 1, LILATracts_1And10 == 1))
rural_food_desert_count <- nrow(data %>% filter(Urban == 0, LILATracts_1And10 == 1))

urban_percentage <- urban_count / total_count * 100
rural_percentage <- rural_count / total_count * 100
urban_food_desert_percentage <- urban_food_desert_count / urban_count * 100
rural_food_desert_percentage <- rural_food_desert_count / rural_count * 100
overall_percentage <- (urban_food_desert_count + rural_food_desert_count) / total_count * 100

cat("There are", urban_count, "Urban Counties\n")
cat("There are", rural_count, "Rural Counties\n\n")

cat("There are", urban_food_desert_count, "Urban Food Deserts\n")
cat("There are", rural_food_desert_count, "Rural Food Deserts\n\n")

cat("The Urban tracts constitute", round(urban_percentage, 2), "% of the total Census tracts\n")
cat("The Rural tracts constitute", round(rural_percentage, 2), "% of the total Census tracts\n\n")

cat("Based on the dataset, it is found that", round(urban_food_desert_percentage, 2), "% of the Urban tracts are food deserts\n")
cat("And", round(rural_food_desert_percentage, 2), "% of the Rural tracts are food deserts\n\n")

cat("Overall,", round(overall_percentage, 2), "% are food deserts based on the analysis made over the dataset\n")
cat("From the analysis, it is evident that Food Deserts are more common in the Urban Areas, due to many factors like Population, Poverty Rates, Low Access and Low Income tracts")
```

## Question 4: Relationship between Poverty Rate and Food Deserts

### Analyzing Poverty Rate in Different Tracts

```{r}

# Assuming `data` is the dataframe you have
data %>% 
  group_by(LILATracts_1And10) %>% 
  summarise(mean_poverty_rate = mean(PovertyRate))

data %>% 
  group_by(LILATracts_1And20) %>% 
  summarise(mean_poverty_rate = mean(PovertyRate))

data %>% 
  group_by(LowIncomeTracts) %>% 
  summarise(mean_poverty_rate = mean(PovertyRate))

## Poverty rate is high in non low access areas
data %>% 
  group_by(LA1and10) %>% 
  summarise(mean_poverty_rate = mean(PovertyRate))

data %>% 
  group_by(LA1and20) %>% 
  summarise(mean_poverty_rate = mean(PovertyRate))

```
## Relationship between states and poverty rate

### Calculate statewise average poverty rate

```{r statewise_poverty_rate }

states_pov <- data %>% 
  group_by(State) %>% 
  summarise(avg_poverty_rate = mean(PovertyRate))
print(states_pov)
```
### Normalize poverty rate

```{r statewise_avg_poverty_rate }
states_pov$norm_poverty_rate <- scale(states_pov$avg_poverty_rate)
print(states_pov)
```
### Identify states with high poverty
```{r high_pov_states}
threshold <- quantile(states_pov$norm_poverty_rate, 0.85)
states_high_pov <- states_pov %>% 
  filter(norm_poverty_rate > threshold)
print(states_high_pov)

```

### Correlation between states and food deserts

```{r corr_states_food_deserts}
# Calculate statewise food desert count
states_food_deserts <- data %>% 
  filter(LILATracts_1And10 == 1) %>% 
  count(State)
print(states_food_deserts)

# Normalize food desert counts
states_food_deserts$norm_count <- scale(states_food_deserts$n)

length(states_high_pov$norm_poverty_rate)
length(states_food_deserts$norm_count)

merged_data <- inner_join(states_high_pov, states_food_deserts, by = "State")
# Get correlation
# There is no correlation between poverty rates and food desert status
# The states with high poverty don't have high number of food deserts
print(cor(merged_data$norm_poverty_rate, merged_data$norm_count, method = "pearson"))
#### Checking correlation of poverty rate and food desert status of all the states 
#### There is very less correlation between povery rate and food deserts in all states
print(cor(states_pov$norm_poverty_rate, states_food_deserts$norm_count, method = "pearson"))

print(merged_data)
cor.test(merged_data$norm_poverty_rate, merged_data$norm_count, method="pearson")
cor.test(states_pov$norm_poverty_rate, states_food_deserts$norm_count, method="pearson")

```

## Relationship between counties and poverty rate

### Calculate countywise average poverty rate

```{r countywise_poverty_rate }

counties_pov <- data %>% 
  group_by(County) %>% 
  summarise(avg_poverty_rate = mean(PovertyRate))
print(counties_pov)
```
### Normalize county poverty rate

```{r countywise_poverty_rate_normalise }
counties_pov$norm_poverty_rate <- scale(counties_pov$avg_poverty_rate)
print(counties_pov)
```
### Identify county with high poverty
```{r high_pov_counties}
county_threshold <- quantile(counties_pov$norm_poverty_rate, 0.85)
counties_high_pov <- counties_pov %>% 
  filter(norm_poverty_rate > county_threshold)
print(counties_high_pov)

```

### Correlation between counties and food deserts

```{r corr_counties_food_deserts}
# Calculate statewise food desert count
counties_food_deserts <- data %>% 
  filter(LILATracts_1And10 == 1) %>% 
  count(County)
print(counties_food_deserts)

# Normalize food desert counts
counties_food_deserts$norm_count <- scale(counties_food_deserts$n)

length(counties_food_deserts$norm_poverty_rate)
length(counties_food_deserts$norm_count)

counties_merged_data <- inner_join(counties_high_pov, counties_food_deserts, by = "County")
# Get correlation
# There is no correlation between poverty rates and food desert status
# The states with high poverty don't have high number of food deserts
print(cor(counties_merged_data$norm_poverty_rate, counties_merged_data$norm_count, method = "pearson"))
#### Checking correlation of poverty rate and food desert status of all the states 
#### There is very less correlation between povery rate and food deserts in all states
counties_all_merged_data <- inner_join(counties_pov, counties_food_deserts, by = "County")
print(cor(counties_all_merged_data$norm_poverty_rate, counties_all_merged_data$norm_count, method = "pearson"))

cor.test(counties_merged_data$norm_poverty_rate, counties_merged_data$norm_count, method="pearson")
cor.test(counties_all_merged_data$norm_poverty_rate, counties_all_merged_data$norm_count, method="pearson")


# print(sum(is.na(counties_all_merged_data$norm_poverty_rate)))
# sum(is.infinite(counties_all_merged_data$norm_poverty_rate))
# print(sum(is.na(counties_all_merged_data$norm_count)))
# sum(is.infinite(counties_all_merged_data$norm_count))
#print(counties_all_merged_data)
```

# Question 5: Vehicle Access and Food Deserts
## Visualizing Vehicle Access

#### Filtering and plotting vehicle access
```{r vis_vehicle_access}
data %>% 
  filter(LILATracts_1And10 == 1) %>%
  ggplot(aes(x = lahunv1share)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Percentage of total population who does not have vehicles in food desert")

data %>% 
  filter(LILATracts_1And10 == 0) %>%
  ggplot(aes(x = lahunv1share)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Percentage of total population who does not have vehicles in non-food desert")

data %>% 
  filter(LILATracts_1And10 == 1 & Urban == 1) %>%
  ggplot(aes(x = lahunv1share)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Percentage of urban population who does not have vehicles in food desert")

data %>% 
  filter(LILATracts_1And10 == 1 & Urban == 0) %>%
  ggplot(aes(x = lahunv1share)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Percentage of rural population who does not have vehicles in food desert")

data %>% 
  filter(LILATracts_1And10 == 0 & Urban == 1) %>%
  ggplot(aes(x = lahunv1share)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Percentage of urban population who does not have vehicles in non-food desert")

data %>% 
  filter(LILATracts_1And10 == 0 & Urban == 0) %>%
  ggplot(aes(x = lahunv1share)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Percentage of rural population who does not have vehicles in non-food desert")
```

### Share of population without vehicles - boxplots

``` {r vehicle_box_plots}
data$LILATracts_1And10 <- as.factor(data$LILATracts_1And10)


levels(data$LILATracts_1And10) <- c("Non-Food desert", "Food desert")

ggplot(data = data,
       aes(x = c(LILATracts_1And10,Urban), y =lahunv1share)) +
      geom_boxplot(fill='white', color="darkred") +
      labs(title="Percentage of total population who does not have vehicles in food desert and non-food deserts",
      x ="Types of tracts ", y = "Population share without vehicles") +
      theme(plot.title = element_text(hjust = 0.5))
  
```
#### Observations from the box plot

Central Tendency: The median line inside the box for the "food desert" category appears to be higher than the "non-food desert" category. This suggests that, on average, a higher percentage of the population in food deserts lack vehicles compared to those in non-food deserts.

Spread & Variability: The interquartile range (box height) for both categories is roughly similar, indicating a similar spread or variability in the data for both food and non-food deserts.

Outliers: There are some outliers in both categories, but it's particularly noticeable in the "non-food desert" category. This indicates that while most non-food desert tracts have a relatively lower percentage of people without vehicles, there are a few tracts where this isn't the case.

Skewness: The median line appears to be roughly in the middle of the box for both categories, suggesting that the distribution of the share of the population without vehicles in both food and non-food desert tracts is roughly symmetric.

Overall Comparison: The entire box (representing the middle 50% of the data) for the "food desert" category is higher on the y-axis compared to the "non-food desert" category. This indicates that a larger share of the population in food deserts typically lacks vehicles compared to those in non-food deserts. This could be concerning, as people in food deserts without vehicles may have even more difficulty accessing fresh and healthy food.

### Vehicle access in rural and urban tracts 

```{r veh_access_urban_rural}
data$Urban <- as.factor(data$Urban)
levels(data$Urban) <- c("Rural", "Urban")
ggplot(data = data,
       aes(x = interaction(LILATracts_1And10, Urban), y = lahunv1share)) +
  geom_boxplot(fill='white', color="darkred") +
  labs(title="Percentage of total population who does not have vehicles",
       x ="Types of tracts", y = "Population share without vehicles") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r outlier_removal_vehicle_access}
app_wo_gre_outlier <- ezids::outlierKD2(data, lahunv1share ,qqplt= TRUE, boxplt= TRUE, rm = TRUE)
str(app_wo_gre_outlier)
#gre_na = sum(is.na(app_wo_gre_outlier$gre))
```

```{r veh_access_urban_rural_without_outliers}
app_wo_gre_outlier$Urban <- as.factor(app_wo_gre_outlier$Urban)
levels(app_wo_gre_outlier$Urban) <- c("Rural", "Urban")

app_wo_gre_outlier$LILATracts_1And10 <- as.factor(app_wo_gre_outlier$LILATracts_1And10)
levels(app_wo_gre_outlier$LILATracts_1And10) <- c("Non-food desert", "Food desert")
ggplot(data = app_wo_gre_outlier,
       aes(x = interaction(LILATracts_1And10, Urban), y = lahunv1share)) +
  geom_boxplot(fill='white', color="darkred") +
  labs(title="Percentage of total population who does not have vehicles - outliers removed",
       x ="Types of tracts", y = "Population share without vehicles") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

# Question 6: Income-related Variables and Food Deserts
## Visualizing Median Family Income

```{r medincom_food_deserts}
data %>% 
  filter(LILATracts_1And10 == 1) %>%
  ggplot(aes(x = MedianFamilyIncome)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Median Family Income in Food Deserts")

data %>% 
  filter(LILATracts_1And10 == 0) %>%
  ggplot(aes(x = MedianFamilyIncome)) +
  geom_histogram(bins = 50) +
  geom_density(alpha = 0.5) +
  labs(title = "Median Family Income in Non-food Deserts")
```

### Median income in food desert - boxplots

``` {r medincome_box_plots}
data$LILATracts_1And10 <- as.factor(data$LILATracts_1And10)


levels(data$LILATracts_1And10) <- c("Non-Food desert", "Food desert")

ggplot(data = data,
       aes(x = LILATracts_1And10, y = MedianFamilyIncome)) +
      geom_boxplot(fill='white', color="darkred") +
      labs(title="Median Family Income between food desert and non-food deserts",
      x ="Types of tracts ", y = "MedianFamilyIncome") +
      theme(plot.title = element_text(hjust = 0.5))
  
```

``` {r medincome_urban_box_plots}
data$LILATracts_1And10 <- as.factor(data$LILATracts_1And10)
levels(data$LILATracts_1And10) <- c("Non-Food desert", "Food desert")

data$Urban <- as.factor(data$Urban)
levels(data$Urban) <- c("Rural", "Urban")
ggplot(data = data,
       aes(x = interaction(LILATracts_1And10, Urban), y = MedianFamilyIncome)) +
      geom_boxplot(fill='white', color="darkred") +
      labs(title="Median Family Income between in urban and rural food deserts",
      x ="Types of tracts ", y = "MedianFamilyIncome") +
      theme(plot.title = element_text(hjust = 0.5))
  
```

```{r food_desert_confidence_interval}
fd_data <- subset(data, data$LILATracts_1And10 == "Food desert") 

non_fd_data <- subset(data, data$LILATracts_1And10 == "Non-Food desert") 
#print(fd_data)
ttest_fd_medincome_95 = t.test(x=fd_data$MedianFamilyIncome, conf.level=0.95 )
ttest_non_fd_medincome_95 = t.test(x=non_fd_data$MedianFamilyIncome, conf.level=0.95 )

print(ttest_fd_medincome_95)
print(ttest_non_fd_medincome_95)
```

### Food deserts

The T-intervals for the median income 

* **At 0.95 level** 
  
   [`r ttest_fd_medincome_95$conf.int[1] `, `r ttest_fd_medincome_95$conf.int[2] `] 
   
### Non-Food deserts

The T-intervals for the median income in non-food desert 

* **At 0.95 level** 
  
   [`r ttest_non_fd_medincome_95$conf.int[1] `, `r =ttest_non_fd_medincome_95$conf.int[2] `] 
   
## ANOVA ON median income
Null hypothesis : There is no difference in the median income between food desert and non-food desert
Alternate hypothesis : There is difference in the median income between food desert and non-food desert

   
```{r anova_med_incom_food_desert}
med_income_aov = aov(MedianFamilyIncome ~ LILATracts_1And10, data = data)
# plant_aov  # this does not give the easy-to-read result of the aov analysis
# summary(plant_aov)
plantaovsummary = summary(med_income_aov)
plantaovsummary
```

At level of significance alpha set at = 0.05, as The p-value 2e-16  is less than the 0.05, we reject the null hypothesis "There is no difference in the median income between food desert and non-food desert"
Given the large F value and the extremely low p-value, we can be confident in this result.

The anova results tell us that there is statistically significant difference in median income among food desert and non -deserts.


### Post-hoc Tukey HSD

```{r tukeyHSD}
tukeyAoV <- TukeyHSD(med_income_aov)
tukeyAoV
```
The post-hoc test confirms that families living in food deserts have a significantly lower median income compared to those not living in food deserts.
